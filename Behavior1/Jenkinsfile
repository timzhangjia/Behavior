pipeline {
    agent any
    
    environment {
        PYTHON_VERSION = '3.8'
        PROJECT_DIR = '${WORKSPACE}'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'Checkout code from repository'
                checkout scm
            }
        }
        
        stage('Setup') {
            steps {
                echo 'Setup Python environment'
                sh '''
                    python -m venv venv
                    source venv/bin/activate || venv\\Scripts\\activate
                    pip install -r requirements.txt
                    playwright install
                '''
            }
        }
        
        stage('Run Tests') {
            steps {
                echo 'Running tests'
                sh '''
                    source venv/bin/activate || venv\\Scripts\\activate
                    python run.py --parallel -w 4
                '''
            }
        }
        
        stage('Generate Report') {
            steps {
                echo 'Generating Allure report'
                sh '''
                    source venv/bin/activate || venv\\Scripts\\activate
                    python run.py --report
                '''
                allure([
                    includeProperties: false,
                    jdk: '',
                    properties: [],
                    reportBuildPolicy: 'ALWAYS',
                    results: [[path: 'allure-results']]
                ])
            }
        }
        
        stage('Archive Results') {
            steps {
                echo 'Archiving test results'
                archiveArtifacts artifacts: 'allure-report/**', fingerprint: true
            }
        }
    }
    
    post {
        always {
            echo 'Cleanup'
            sh '''
                source venv/bin/activate || venv\\Scripts\\activate
                rm -rf venv
            '''
        }
        success {
            echo 'Tests passed successfully'
        }
        failure {
            echo 'Tests failed'
        }
    }
}


